# -*- coding: utf-8 -*-
"""
Enhanced Analysis Display Module
=================================
xG ve Momentum analizlerini g√∂rselle≈ütirme
"""

import streamlit as st
import plotly.graph_objects as go
import plotly.express as px
from typing import Dict, List, Any
import pandas as pd
from xg_calculator import xGCalculator, LivexGTracker
from momentum_tracker import MomentumTracker, MomentumVisualizer


def display_xg_analysis(fixture_data: Dict, api_key: str = None):
    """
    xG Analizi g√∂sterimi
    
    Args:
        fixture_data: Ma√ß verileri
        api_key: API anahtarƒ± (canlƒ± veri i√ßin)
    """
    st.subheader("‚öΩ Expected Goals (xG) Analizi")
    
    # xG Calculator
    calc = xGCalculator()
    
    # Tab'lar
    tab1, tab2, tab3 = st.tabs(["üìä xG √ñzeti", "üéØ ≈ûut Analizi", "üìà xG Timeline"])
    
    with tab1:
        display_xg_summary(fixture_data, calc)
    
    with tab2:
        display_shot_analysis(fixture_data, calc)
    
    with tab3:
        display_xg_timeline(fixture_data)


def display_xg_summary(fixture_data: Dict, calc: xGCalculator):
    """xG √∂zet g√∂sterimi"""
    
    # Takƒ±m isimleri
    home_team = fixture_data.get('home_team', 'Ev Sahibi')
    away_team = fixture_data.get('away_team', 'Deplasman')
    
    # Tahmin edilen xG hesapla (istatistiklerden)
    home_stats = fixture_data.get('home_stats', {})
    away_stats = fixture_data.get('away_stats', {})
    
    home_xg_data = calc.calculate_team_xg(home_stats, away_stats)
    away_xg_data = calc.calculate_team_xg(away_stats, home_stats)
    
    home_xg = home_xg_data['estimated_xg']
    away_xg = away_xg_data['estimated_xg']
    
    # Ger√ßek skorlar (varsa)
    home_goals = fixture_data.get('home_goals', 0)
    away_goals = fixture_data.get('away_goals', 0)
    
    # Ana metrikler
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            label=f"üè† {home_team} xG",
            value=f"{home_xg:.2f}",
            delta=f"{home_goals - home_xg:.2f}" if home_goals > 0 else None
        )
    
    with col2:
        st.metric(
            label="‚öñÔ∏è xG Farkƒ±",
            value=f"{abs(home_xg - away_xg):.2f}",
            delta="Ev Sahibi" if home_xg > away_xg else "Deplasman"
        )
    
    with col3:
        st.metric(
            label=f"‚úàÔ∏è {away_team} xG",
            value=f"{away_xg:.2f}",
            delta=f"{away_goals - away_xg:.2f}" if away_goals > 0 else None
        )
    
    # xG Bar Chart
    fig = go.Figure()
    
    fig.add_trace(go.Bar(
        name=home_team,
        x=['Expected Goals'],
        y=[home_xg],
        marker_color='#3498db',
        text=[f"{home_xg:.2f}"],
        textposition='auto',
    ))
    
    fig.add_trace(go.Bar(
        name=away_team,
        x=['Expected Goals'],
        y=[away_xg],
        marker_color='#e74c3c',
        text=[f"{away_xg:.2f}"],
        textposition='auto',
    ))
    
    if home_goals > 0 or away_goals > 0:
        fig.add_trace(go.Bar(
            name='Ger√ßek Goller',
            x=['Actual Goals'],
            y=[home_goals],
            marker_color='#2ecc71',
            text=[f"{home_goals}"],
            textposition='auto',
        ))
        
        fig.add_trace(go.Bar(
            x=['Actual Goals'],
            y=[away_goals],
            marker_color='#f39c12',
            text=[f"{away_goals}"],
            textposition='auto',
            showlegend=False
        ))
    
    fig.update_layout(
        title="Expected Goals vs Actual Goals",
        barmode='group',
        height=400
    )
    
    st.plotly_chart(fig, use_container_width=True)
    
    # Performans analizi
    if home_goals > 0 or away_goals > 0:
        st.markdown("---")
        st.markdown("### üéØ Bitiricilik Performansƒ±")
        
        col1, col2 = st.columns(2)
        
        with col1:
            home_comp = calc.compare_xg_vs_goals(home_xg, home_goals)
            st.markdown(f"**{home_team}**")
            st.markdown(f"- Performans: **{home_comp['performance']}**")
            st.markdown(f"- Verimlilik: **{home_comp['efficiency']}%**")
            st.markdown(f"- Deƒüerlendirme: {home_comp['luck']}")
        
        with col2:
            away_comp = calc.compare_xg_vs_goals(away_xg, away_goals)
            st.markdown(f"**{away_team}**")
            st.markdown(f"- Performans: **{away_comp['performance']}**")
            st.markdown(f"- Verimlilik: **{away_comp['efficiency']}%**")
            st.markdown(f"- Deƒüerlendirme: {away_comp['luck']}")


def display_shot_analysis(fixture_data: Dict, calc: xGCalculator):
    """≈ûut bazlƒ± analiz"""
    st.markdown("### üéØ ≈ûut Kalitesi Analizi")
    
    # √ñrnek ≈üutlar (ger√ßek API'den gelecek)
    shots_data = fixture_data.get('shots', [])
    
    if not shots_data:
        st.info("≈ûut verileri hen√ºz mevcut deƒüil")
        
        # Demo ≈üutlar g√∂ster
        st.markdown("#### üìç √ñrnek xG Hesaplamalarƒ±")
        
        demo_shots = [
            {
                'name': 'Ceza Sahasƒ± ƒ∞√ßi (Merkez)',
                'params': {'distance': 10, 'angle': 10, 'situation': 'open_play', 'defender_count': 1}
            },
            {
                'name': '1v1 Pozisyon',
                'params': {'distance': 8, 'angle': 5, 'situation': 'one_on_one', 'defender_count': 0, 'goalkeeper_position': 'bad'}
            },
            {
                'name': 'Penaltƒ±',
                'params': {'distance': 11, 'angle': 0, 'situation': 'penalty', 'defender_count': 0}
            },
            {
                'name': 'Uzak Mesafe',
                'params': {'distance': 28, 'angle': 20, 'situation': 'open_play', 'defender_count': 3}
            },
            {
                'name': 'Korner Sonrasƒ± Kafa',
                'params': {'distance': 9, 'angle': 25, 'situation': 'corner', 'is_header': True, 'defender_count': 2}
            },
        ]
        
        for shot in demo_shots:
            result = calc.calculate_shot_xg(**shot['params'])
            
            with st.expander(f"{shot['name']} - xG: {result['xg_value']:.3f}"):
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("**Fakt√∂rler:**")
                    st.write(result['factors'])
                
                with col2:
                    st.markdown("**√áarpanlar:**")
                    st.write(result['multipliers'])
    else:
        # Ger√ßek ≈üut analizi
        for shot in shots_data:
            display_shot_card(shot, calc)


def display_shot_card(shot: Dict, calc: xGCalculator):
    """Tek ≈üut kartƒ±"""
    xg_result = calc.calculate_shot_xg(**shot['params'])
    
    with st.container():
        col1, col2, col3 = st.columns([2, 1, 1])
        
        with col1:
            st.markdown(f"**{shot.get('player', 'Oyuncu')}** - {shot.get('minute', 0)}'")
            st.progress(xg_result['xg_value'])
        
        with col2:
            st.metric("xG", f"{xg_result['xg_value']:.3f}")
        
        with col3:
            is_goal = shot.get('is_goal', False)
            st.markdown("‚öΩ **GOL**" if is_goal else "‚ùå Ka√ßtƒ±")


def display_xg_timeline(fixture_data: Dict):
    """xG zaman √ßizelgesi"""
    st.markdown("### üìà xG Timeline")
    
    # √ñrnek timeline verisi
    timeline_data = fixture_data.get('xg_timeline', [])
    
    if not timeline_data:
        st.info("Timeline verisi hen√ºz mevcut deƒüil")
        
        # Demo timeline
        demo_timeline = [
            {'minute': 5, 'home_xg': 0.15, 'away_xg': 0},
            {'minute': 12, 'home_xg': 0.35, 'away_xg': 0.08},
            {'minute': 18, 'home_xg': 0.35, 'away_xg': 0.28},
            {'minute': 25, 'home_xg': 0.82, 'away_xg': 0.28},
            {'minute': 35, 'home_xg': 0.82, 'away_xg': 0.55},
            {'minute': 42, 'home_xg': 1.15, 'away_xg': 0.55},
            {'minute': 50, 'home_xg': 1.15, 'away_xg': 0.92},
            {'minute': 67, 'home_xg': 1.58, 'away_xg': 0.92},
            {'minute': 78, 'home_xg': 1.58, 'away_xg': 1.23},
            {'minute': 90, 'home_xg': 1.85, 'away_xg': 1.45},
        ]
        timeline_data = demo_timeline
    
    # Timeline grafiƒüi
    fig = go.Figure()
    
    minutes = [t['minute'] for t in timeline_data]
    home_xg = [t['home_xg'] for t in timeline_data]
    away_xg = [t['away_xg'] for t in timeline_data]
    
    fig.add_trace(go.Scatter(
        x=minutes,
        y=home_xg,
        name='Ev Sahibi xG',
        mode='lines+markers',
        line=dict(color='#3498db', width=3),
        fill='tozeroy'
    ))
    
    fig.add_trace(go.Scatter(
        x=minutes,
        y=away_xg,
        name='Deplasman xG',
        mode='lines+markers',
        line=dict(color='#e74c3c', width=3),
        fill='tozeroy'
    ))
    
    fig.update_layout(
        title="K√ºm√ºlatif xG Geli≈üimi",
        xaxis_title="Dakika",
        yaxis_title="K√ºm√ºlatif xG",
        hovermode='x unified',
        height=500
    )
    
    st.plotly_chart(fig, use_container_width=True)


def display_momentum_analysis(fixture_data: Dict):
    """
    Momentum analizi g√∂sterimi
    
    Args:
        fixture_data: Ma√ß verileri
    """
    st.subheader("‚ö° Canlƒ± Momentum Analizi")
    
    # Momentum Tracker
    tracker = MomentumTracker(window_size=10)
    
    # Ma√ß olaylarƒ±nƒ± y√ºkle (ger√ßek API'den gelecek)
    events = fixture_data.get('events', [])
    
    if events:
        for event in events:
            tracker.add_event(
                minute=event['minute'],
                team=event['team'],
                event_type=event['type'],
                details=event.get('details')
            )
    else:
        # Demo events
        demo_events = [
            {'minute': 5, 'team': 'home', 'type': 'shot_on_target'},
            {'minute': 8, 'team': 'home', 'type': 'corner'},
            {'minute': 12, 'team': 'away', 'type': 'shot_on_target'},
            {'minute': 15, 'team': 'home', 'type': 'goal'},
            {'minute': 20, 'team': 'away', 'type': 'big_chance_created'},
            {'minute': 23, 'team': 'away', 'type': 'shot_on_target'},
            {'minute': 28, 'team': 'away', 'type': 'goal'},
            {'minute': 35, 'team': 'home', 'type': 'corner'},
            {'minute': 40, 'team': 'home', 'type': 'shot_on_target'},
            {'minute': 45, 'team': 'away', 'type': 'yellow_card'},
        ]
        
        for event in demo_events:
            tracker.add_event(**event)
    
    # Tab'lar
    tab1, tab2, tab3, tab4 = st.tabs([
        "üìä Mevcut Durum",
        "üìà Momentum Timeline",
        "üî• Kritik Anlar",
        "üìã Detaylƒ± Rapor"
    ])
    
    with tab1:
        display_current_momentum(tracker)
    
    with tab2:
        display_momentum_timeline(tracker)
    
    with tab3:
        display_critical_moments(tracker)
    
    with tab4:
        display_momentum_report(tracker)


def display_current_momentum(tracker: MomentumTracker):
    """Mevcut momentum durumu"""
    current = tracker.get_current_momentum()
    pressure = tracker.get_pressure_index()
    next_goal = tracker.predict_next_goal()
    
    # Momentum bar
    viz = MomentumVisualizer()
    st.markdown(viz.get_momentum_bar_html(current['momentum']), unsafe_allow_html=True)
    
    # Metrikler
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "Baskƒ±n Takƒ±m",
            current['dominant_team'].upper(),
            viz.get_strength_emoji(current['strength'])
        )
    
    with col2:
        st.metric(
            "Trend",
            current['trend'].replace('_', ' ').title(),
            viz.get_trend_emoji(current['trend'])
        )
    
    with col3:
        st.metric(
            "Ev Sahibi Baskƒ±",
            f"{pressure['home']}%"
        )
    
    with col4:
        st.metric(
            "Deplasman Baskƒ±",
            f"{pressure['away']}%"
        )
    
    # Sonraki gol tahmini
    st.markdown("---")
    st.markdown("### üéØ Sonraki Gol Tahmini")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric(
            "Ev Sahibi Olasƒ±lƒ±ƒüƒ±",
            f"{next_goal['home_probability']}%"
        )
        st.progress(next_goal['home_probability'] / 100)
    
    with col2:
        st.metric(
            "Deplasman Olasƒ±lƒ±ƒüƒ±",
            f"{next_goal['away_probability']}%"
        )
        st.progress(next_goal['away_probability'] / 100)
    
    st.info(f"**En Olasƒ±:** {next_goal['likely_scorer'].upper()} - G√ºven: {next_goal['confidence'].upper()}")


def display_momentum_timeline(tracker: MomentumTracker):
    """Momentum timeline grafiƒüi"""
    timeline = tracker.get_momentum_timeline()
    
    if not timeline:
        st.info("Hen√ºz momentum verisi yok")
        return
    
    # DataFrame olu≈ütur
    df = pd.DataFrame(timeline)
    
    # Grafik
    fig = go.Figure()
    
    fig.add_trace(go.Scatter(
        x=df['minute'],
        y=df['momentum'],
        mode='lines+markers',
        name='Momentum',
        line=dict(color='#3498db', width=3),
        fill='tozeroy',
        fillcolor='rgba(52, 152, 219, 0.3)'
    ))
    
    # 0 √ßizgisi
    fig.add_hline(y=0, line_dash="dash", line_color="gray")
    
    # Momentum b√∂lgeleri
    fig.add_hrect(y0=50, y1=100, fillcolor="green", opacity=0.1, annotation_text="Ev G√º√ßl√º")
    fig.add_hrect(y0=20, y1=50, fillcolor="lightgreen", opacity=0.1, annotation_text="Ev √úst√ºn")
    fig.add_hrect(y0=-20, y1=20, fillcolor="yellow", opacity=0.1, annotation_text="Dengeli")
    fig.add_hrect(y0=-50, y1=-20, fillcolor="orange", opacity=0.1, annotation_text="Deplasman √úst√ºn")
    fig.add_hrect(y0=-100, y1=-50, fillcolor="red", opacity=0.1, annotation_text="Deplasman G√º√ßl√º")
    
    fig.update_layout(
        title="Momentum Geli≈üimi",
        xaxis_title="Dakika",
        yaxis_title="Momentum Skoru",
        hovermode='x unified',
        height=500,
        yaxis=dict(range=[-100, 100])
    )
    
    st.plotly_chart(fig, use_container_width=True)
    
    # Momentum deƒüi≈üimleri
    shifts = tracker.detect_momentum_shifts(threshold=30)
    
    if shifts:
        st.markdown("### üîÑ √ñnemli Momentum Deƒüi≈üimleri")
        
        for shift in shifts:
            with st.expander(f"‚è±Ô∏è {shift['minute']}' - {shift['direction'].upper()} Takƒ±mƒ±na Ge√ßi≈ü"):
                st.markdown(f"**Deƒüi≈üim:** {shift['from']:.1f} ‚Üí {shift['to']:.1f} ({shift['change']:+.1f})")
                if shift['trigger_events']:
                    st.markdown("**Tetikleyen Olaylar:**")
                    for event in shift['trigger_events']:
                        st.markdown(f"- {event['minute']}': {event['type']} ({event['team']})")


def display_critical_moments(tracker: MomentumTracker):
    """Kritik anlar listesi"""
    critical = tracker.get_critical_moments()
    
    if not critical:
        st.info("Hen√ºz kritik an tespit edilmedi")
        return
    
    st.markdown("### üî• Ma√ßƒ±n Kritik Anlarƒ±")
    
    # √ñnem derecesine g√∂re renk
    importance_colors = {
        'very_high': 'üî¥',
        'high': 'üü†',
        'medium': 'üü°',
        'low': 'üü¢'
    }
    
    for moment in critical:
        emoji = importance_colors.get(moment['importance'], '‚ö™')
        
        st.markdown(f"""
        <div style="padding: 10px; margin: 5px 0; border-left: 4px solid #3498db; background: #f8f9fa;">
            <strong>{emoji} {moment['minute']}'</strong> - {moment['description']}
            <br><small>√ñnem: {moment['importance']}</small>
        </div>
        """, unsafe_allow_html=True)


def display_momentum_report(tracker: MomentumTracker):
    """Detaylƒ± momentum raporu"""
    report = tracker.get_match_report()
    
    st.markdown("### üìã Kapsamlƒ± Momentum Raporu")
    
    # Ma√ß fazƒ±
    phase_names = {
        'early': 'üåÖ Erken Dakikalar',
        'settling': '‚öñÔ∏è Dengeye Gelme',
        'first_half_end': 'üïê ƒ∞lk Yarƒ± Sonu',
        'second_half_start': 'üîÑ ƒ∞kinci Yarƒ± Ba≈üƒ±',
        'mid_second_half': '‚ö° ƒ∞kinci Yarƒ± Ortasƒ±',
        'crucial': 'üî• Kritik Dakikalar',
        'final_push': 'üéØ Son Baskƒ±'
    }
    
    st.info(f"**Ma√ß Fazƒ±:** {phase_names.get(report['match_phase'], 'Bilinmiyor')}")
    
    # ƒ∞statistikler
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### üìä Genel ƒ∞statistikler")
        st.write(f"- Toplam Olay: **{report['total_events']}**")
        st.write(f"- Momentum Deƒüi≈üimi: **{report['momentum_shifts']}**")
        st.write(f"- Kritik An: **{len(report['critical_moments'])}**")
    
    with col2:
        st.markdown("#### üé≤ Olay Daƒüƒ±lƒ±mƒ±")
        if report['event_breakdown']:
            event_df = pd.DataFrame(
                list(report['event_breakdown'].items()),
                columns=['Olay', 'Sayƒ±']
            ).sort_values('Sayƒ±', ascending=False).head(5)
            st.dataframe(event_df, hide_index=True)


# Ana entegrasyon fonksiyonu
def display_advanced_analysis_tab(fixture_data: Dict):
    """
    Geli≈ümi≈ü analiz sekmesi
    
    Args:
        fixture_data: Ma√ß verileri
    """
    st.title("üöÄ Geli≈ümi≈ü Analiz Sistemi")
    
    analysis_type = st.selectbox(
        "Analiz T√ºr√º Se√ßin:",
        ["‚öΩ xG (Expected Goals) Analizi", "‚ö° Momentum Analizi", "üìä Kombine Analiz"]
    )
    
    if analysis_type == "‚öΩ xG (Expected Goals) Analizi":
        display_xg_analysis(fixture_data)
    elif analysis_type == "‚ö° Momentum Analizi":
        display_momentum_analysis(fixture_data)
    else:
        # Kombine
        col1, col2 = st.columns(2)
        with col1:
            display_xg_analysis(fixture_data)
        with col2:
            display_momentum_analysis(fixture_data)


if __name__ == "__main__":
    # Demo
    demo_fixture = {
        'home_team': 'Galatasaray',
        'away_team': 'Fenerbah√ße',
        'home_goals': 2,
        'away_goals': 1,
        'home_stats': {
            'shots_total': 15,
            'shots_on_target': 8,
            'shots_inside_box': 10,
            'shots_outside_box': 5,
            'is_home': True
        },
        'away_stats': {
            'shots_total': 12,
            'shots_on_target': 5,
            'shots_inside_box': 7,
            'shots_outside_box': 5,
            'defense_rating': 65
        }
    }
    
    display_advanced_analysis_tab(demo_fixture)
